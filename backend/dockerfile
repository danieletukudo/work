# =========================
# Stage 1: Builder
# =========================
FROM python:3.12-slim AS builder

WORKDIR /app

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    cmake \
    portaudio19-dev \
    && rm -rf /var/lib/apt/lists/*

COPY requirements.txt .
RUN python -m pip install --upgrade pip && \
    pip install --no-cache-dir --prefix=/install -r requirements.txt


# =========================
# Stage 2: Runtime
# =========================
FROM python:3.12-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PORT=8000 \
    TEMP_DIR=/app/temp_pics

RUN useradd -ms /bin/bash appuser

WORKDIR /app

RUN apt-get update && apt-get install -y --no-install-recommends \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libportaudio2 \
    ffmpeg \
    openssh-server \
    supervisor \
    && rm -rf /var/lib/apt/lists/*

# Azure-required SSH directories
RUN mkdir -p /var/run/sshd /tmp/sshd

# Fix PAM (Azure requirement)
RUN sed -i 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' /etc/pam.d/sshd

# ---------------------------------------------------
# CREATE THE REQUIRED sshd_config FILE IN DOCKERFILE
# ---------------------------------------------------

# Create SSH configuration
RUN printf "%s\n" \
"Port 2222" \
"Protocol 2" \
"PermitRootLogin yes" \
"PasswordAuthentication yes" \
"UsePAM yes" \
"Subsystem sftp /usr/lib/ssh/sftp-server" \
> /etc/ssh/sshd_config


# Root password for Azure SSH
RUN echo "root:Docker!" | chpasswd

# Copy installed dependencies
COPY --from=builder /install /usr/local

# Copy app source
COPY --chown=appuser:appuser . /app

# Copy supervisord config
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Remove existing logs
RUN rm -rf /cv_agent/logs/* || true \
    && rm -rf /face_verifier/logs/* || true \
    && rm -rf /job_posting_agent/logs/* || true \
    && rm -rf /personality_agent/logs/* || true

EXPOSE 8000 2222

CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]

